name: build-windows
on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    env:
      # ✅ Pon tus valores aquí o, mejor, usa GitHub Secrets (ver notas abajo)
      RS_PUB_KEY: ${{ secrets.RS_PUB_KEY }}
      RENDEZVOUS_SERVER: ${{ secrets.RENDEZVOUS_SERVER }}
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust (MSVC)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 2024.11.16

      - name: Install native deps (vcpkg, Windows/MSVC)
        run: vcpkg install libvpx libyuv opus aom --triplet x64-windows

      - name: Build RustDesk (release)
        run: cargo build --release --target x86_64-pc-windows-msvc

      # Sciter DLL necesaria junto al exe
      - name: Bundle Sciter runtime (sciter.dll)
        shell: pwsh
        run: |
          $url = "https://sciter.com/download/sciter-sdk.zip"
          $zip = "sciter-sdk.zip"
          Invoke-WebRequest $url -OutFile $zip
          Expand-Archive $zip -DestinationPath sdk -Force
          $dll = Get-ChildItem -Recurse sdk | Where-Object {$_.Name -ieq "sciter.dll"} | Select-Object -First 1
          Copy-Item $dll.FullName "target\x86_64-pc-windows-msvc\release\sciter.dll" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows
          path: |
            target\x86_64-pc-windows-msvc\release\rustdesk.exe
            target\x86_64-pc-windows-msvc\release\sciter.dll
